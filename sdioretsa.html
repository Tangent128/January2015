<html>
	<head>
		<script src="js/loader.js" type="application/javascript" async="async"></script>
		<script src="js/applet.js" type="application/javascript" async="async"></script>
		<script src="js/entity.js" type="application/javascript" async="async"></script>
        <script src="js/fireworks.js" type="application/javascript" async="async"></script>
        <script src="js/breakout.js" type="application/javascript" async="async"></script>
		<script src="js/sdioretsa.js" type="application/javascript" async="async"></script>
		<script>
			var _5gon = _5gon || [];
			_5gon.push(function(loaded) {
				var debug = function(txt, set) {
					if(console && console.log) {
						console.log(txt)
						set.each(function(entity) {
							console.log(entity.label);
						});
					}
				}
				
				loaded("$.ready", "Applet", "Fireworks", "sdioretsa", "Breakout", "Entities").then(
				function($, Applet, Fireworks, sdioretsa, Breakout, Entities) {
					var $gameCanvas = $("#gameCanvas");
					var applet = new Applet($gameCanvas);
					$gameCanvas.focus();

                    
                    applet.keys.mapKey(37, "left");
                    applet.keys.mapKey(39, "right");
                    applet.keys.mapKey(32, "reset");
  
					var tickLength = 1/60;
                    
                    var gameState = new sdioretsa.GameState();
                    var gameEntities = new Entities.EntitySet();
                    var shipEntities = new Entities.EntitySet();
                    var gravityEntities = new Entities.EntitySet();
                    var bulletEntities = new Entities.EntitySet();
                                                                          
                    var testPosition = new Entities.Location(200,200);
                    var testPosition2 = new Entities.Location(500,200);
                    var bounds = new Breakout.Rectangle(0, 0, applet.width, applet.height);
                    var mouse = applet.mouse;
                    
                    sdioretsa.spawnAsteroid(gameEntities, testPosition, document.getElementById("asteroid"));
                    sdioretsa.spawnShip(shipEntities, testPosition2, document.getElementById("ship"));
                    var well = sdioretsa.spawnWell(gameEntities, document.getElementById("spiral"));
                                             
                    var tickLength = 1/60;
					window.setInterval(function() {
						var cx = applet.context;
						var k = applet.keys;
                            
						// Control
 
						// Movement
 
                        Entities.TimerTickSystem(bulletEntities, tickLength);
                                       
                        sdioretsa.UpdateSpriteFromPhysicsSystem(shipEntities);
                                       
                        sdioretsa.ThrustSystem(shipEntities, tickLength);
                        Fireworks.PhysicsSystem(gameEntities);
                        Fireworks.PhysicsSystem(shipEntities);
                                       
                        Fireworks.PhysicsSystem(bulletEntities);

                        sdioretsa.WrapSystem(gameEntities, bounds);
                        sdioretsa.WrapSystem(shipEntities, bounds);
                        sdioretsa.WrapSystem(bulletEntities, bounds);
                                       
                        sdioretsa.GravityWellControlSystem(well, gravityEntities, mouse);
                        sdioretsa.GravitySystem(gameEntities, gravityEntities, 9.8);
                        sdioretsa.GravitySystem(shipEntities, gravityEntities, 9.8);
            
                                       
						// Logic

                        sdioretsa.EnemyAiTargetingSystem(tickLength, shipEntities, gameEntities);
                        sdioretsa.EnemyAiNavSystem(tickLength, shipEntities, gameEntities, Math.PI * 2);
                        sdioretsa.EnemyAiGunSystem(tickLength, shipEntities, bulletEntities, document.getElementById("bullet"), 1);
                                       
                        // State Cleanup

                        Entities.TimerExpireSystem(bulletEntities);
                                       
						// Render
						cx.fillStyle = "#000";
						cx.fillRect(0,0, applet.width, applet.height);
	
                        sdioretsa.RenderSystem(gameEntities, bounds, cx);
                        sdioretsa.RenderSystem(gravityEntities, bounds, cx);
                        sdioretsa.RenderSystem(shipEntities, bounds, cx);
                        sdioretsa.RenderSystem(bulletEntities, bounds, cx);
                                       
						// Render Cleanup
						
					}, tickLength*1000);
				});
			});
		</script>
	</head>
	<body>
		<canvas id="gameCanvas" width="640" height="360"></canvas>
        <img id="asteroid" src="img/asteroid.png" />
        <img id="spiral" src="img/spiral.png" />
        <img id="bullet" src="img/bullet.png" />
        <img id="ship" src="img/ship.png" />
        <img id="ship2" src="img/ship2.png" />
        <img id="ship3" src="img/ship3.png" />
	</body>
</html>
