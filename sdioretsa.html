<html>
	<head>
		<title>Sdioretsa 1.1</title>
		<script src="js/loader.js" type="application/javascript" async="async"></script>
		<script src="js/applet.js" type="application/javascript" async="async"></script>
		<script src="js/entity.js" type="application/javascript" async="async"></script>
        <script src="js/fireworks.js" type="application/javascript" async="async"></script>
        <script src="js/breakout.js" type="application/javascript" async="async"></script>
		<script src="js/sdioretsa.js" type="application/javascript" async="async"></script>
		<script>
			var _5gon = _5gon || [];
			_5gon.push(function(loaded) {
				var debug = function(txt, set) {
					if(console && console.log) {
						console.log(txt)
						set.each(function(entity) {
							console.log(entity.label);
						});
					}
				}
				
				loaded("$.ready", "Applet", "Fireworks", "sdioretsa", "Breakout", "Entities").then(
				function($, Applet, Fireworks, sdioretsa, Breakout, Entities) {
					var $gameCanvas = $(".SdioretsaCanvas");
					var applet = new Applet($gameCanvas);
					$gameCanvas.focus();

                    
                    applet.keys.mapKey(37, "left");
                    applet.keys.mapKey(39, "right");
                    applet.keys.mapKey(32, "reset");
  
					var tickLength = 1/60;
                    
                    var gameState = new sdioretsa.GameState();
                    
                    // no start screen yet, start game manually:
                    gameState.state = "playing";
                    
                    var asteroidEntities = new Entities.EntitySet();
                    var shipEntities = new Entities.EntitySet();
                    var gravityEntities = new Entities.EntitySet();
                    var bulletEntities = new Entities.EntitySet();
                    var collisionGroup = new Entities.EntitySet();
                                                                          
                    var testPosition = new Entities.Location(200,200);
                    var testPosition2 = new Entities.Location(500,200);
                    var bounds = new Breakout.Rectangle(0, 0, applet.width, applet.height);
                    var mouse = applet.mouse;
                    
                    sdioretsa.spawnAsteroid(2, asteroidEntities, testPosition, document.getElementById("asteroid"));
                    sdioretsa.spawnShip(shipEntities, testPosition2, document.getElementById("ship"));
                    var well = sdioretsa.spawnWell(asteroidEntities, document.getElementById("spiral"));
                                             
                    var tickLength = 1/60;
					window.setInterval(function() {
						var cx = applet.context;
                        
                        if(gameState.state == "playing") {
                        
							// Control

							sdioretsa.GravityWellControlSystem(well, gravityEntities, mouse);
	 
							// Movement
	 
							Entities.TimerTickSystem(bulletEntities, tickLength);
										   
							sdioretsa.UpdateSpriteFromPhysicsSystem(shipEntities);
										   
							sdioretsa.ThrustSystem(shipEntities, tickLength);
							Fireworks.PhysicsSystem(asteroidEntities);
							Fireworks.PhysicsSystem(shipEntities);
										   
							Fireworks.PhysicsSystem(bulletEntities);

							sdioretsa.WrapSystem(asteroidEntities, bounds);
							sdioretsa.WrapSystem(shipEntities, bounds);
							sdioretsa.WrapSystem(bulletEntities, bounds);
							
							sdioretsa.GravitySystem(asteroidEntities, gravityEntities, 9.8);
							//sdioretsa.GravitySystem(shipEntities, gravityEntities, 4.9);
										   
							// Logic

							sdioretsa.EnemyAiTargetingSystem(tickLength, shipEntities, asteroidEntities);
							sdioretsa.EnemyAiNavSystem(tickLength, shipEntities, asteroidEntities, Math.PI * 4);
							sdioretsa.EnemyAiGunSystem(tickLength, shipEntities, bulletEntities, document.getElementById("bullet"), 1);
										   
							// Collisions
							
								// First detect collisions
							
							sdioretsa.CollisionGenerationSystem(asteroidEntities, bulletEntities, collisionGroup);
							sdioretsa.CollisionGenerationSystem(asteroidEntities, shipEntities, collisionGroup);
										   
								// Then mark dead objects
										   
							sdioretsa.BulletCollisionSystem(collisionGroup);
							sdioretsa.ShipCollisionSystem(collisionGroup);
							
                            sdioretsa.AsteroidSplitSystem(asteroidEntities);
                                       
							// State Cleanup
							
							collisionGroup.clear();

							Entities.TimerExpireSystem(bulletEntities);
							Breakout.ReaperSystem(asteroidEntities);
							Breakout.ReaperSystem(shipEntities);
							Breakout.ReaperSystem(bulletEntities);
                        
							sdioretsa.GameWinLossSystem(asteroidEntities, shipEntities, gameState);
						}
						
						// Render
						cx.fillStyle = "#000";
						cx.fillRect(0,0, applet.width, applet.height);
	
                        sdioretsa.RenderSystem(asteroidEntities, bounds, cx);
                        sdioretsa.RenderSystem(gravityEntities, bounds, cx);
                        sdioretsa.RenderSystem(shipEntities, bounds, cx);
                        sdioretsa.RenderSystem(bulletEntities, bounds, cx);
                        
						// Render Cleanup
						
					}, tickLength*1000);
				});
			});
		</script>

		<style>
			body {
				background: #000;
			}
			img {
				/*display: none;*/
			}
			.SdioretsaWrapper {
				position: relative;
				margin-left: auto;
				margin-right: auto;
				width: 640px;
				height: 360px;
			}
			.SdioretsaOverlay {
				position: absolute;
				
				left: 0;
				top: 0;
				bottom: 0;
				right: 0;
				
				border: thin dashed #fff;
			}
			.SdioretsaText {
				/*display: none;*/
				
				position: absolute;
				left: 0;
				right: 0;
				bottom: 0px;
				
				text-align: justify;
				padding: 0em 1em;
				
				color: #ddeedd;
				background: rgba(10,15,10,0.9);
				font-family: sans-serif;
				font-size: 16px;
				font-weight: bold;
			}
			.SdioretsaCanvas {
				position: absolute;
				top: 0;
				left: 0;
			}
		</style>
	</head>
	<body>
		<div class="SdioretsaWrapper">
			<canvas class="SdioretsaCanvas" width="640" height="360"></canvas>
			<div class="SdioretsaOverlay">
				<div class="SdioretsaText">
					Test text. Test text? Test text!
				</div>
			</div>
		</div>
        <img id="asteroid" src="img/asteroid.png" />
        <img id="spiral" src="img/spiral.png" />
        <img id="bullet" src="img/bullet.png" />
        <img id="ship" src="img/ship.png" />
        <img id="ship2" src="img/ship2.png" />
        <img id="ship3" src="img/ship3.png" />
	</body>
</html>
